<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campanhas - Purgatum RPG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Estilos CSS (os mesmos da versão anterior) */
        :root {
            --primary: #917d7d;
            --primary-dark: #7a6868;
            --dark: #0a0a0a;
            --darker: #050505;
            --light: #f0f0f0;
            --light-gray: #aaa;
            --gray: #333;
            --input-bg: #1a1a1a;
            --error: #ff6b6b;
            --success: #4caf50;
        }
        /* ... (restante dos estilos) ... */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <a href="index.html"><img src="assets/logo-purgatum.webp" alt="Purgatum RPG"></a>
        </div>
        <div class="user-profile" id="userProfile">
            </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Campanhas</h1>
            <div>
                <a href="create-campaign.html" class="btn btn-primary"><i class="fas fa-plus"></i> Criar Campanha</a>
                <a href="dashboard.html" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Voltar ao Dashboard</a>
            </div>
        </div>

        <section class="join-campaign-section">
            <h2>Entrar em uma Campanha</h2>
            <form id="joinCampaignForm">
                <div class="form-group">
                    <label for="campaignCode">Código da Campanha</label>
                    <input type="text" id="campaignCode" name="campaignCode" required>
                </div>
                <div class="form-group">
                    <button type="submit">Entrar na Campanha</button>
                </div>
                <p class="error-message" id="joinCampaignError"></p>
                <p class="success-message" id="joinCampaignSuccess"></p>
            </form>
        </section>

        <section class="campaigns-list">
            <h2>Minhas Campanhas</h2>
            <div id="myCampaignsList">
                <p class="empty-message">Nenhuma campanha criada ou participada ainda.</p>
            </div>
        </section>
    </div>

    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuração do Firebase (substitua pelas suas credenciais)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const userProfileNav = document.getElementById('userProfile');
        const joinCampaignForm = document.getElementById('joinCampaignForm');
        const campaignCodeInput = document.getElementById('campaignCode');
        const joinCampaignError = document.getElementById('joinCampaignError');
        const joinCampaignSuccess = document.getElementById('joinCampaignSuccess');
        const myCampaignsList = document.getElementById('myCampaignsList');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const pageState = {
            user: null,
            campaigns: []
        };

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function updateUserProfileNav(user) {
            if (user) {
                const photoURL = user.photoURL || 'assets/default-profile.png';
                const displayName = user.displayName || 'Usuário';
                userProfileNav.innerHTML = `
                    <img src="${photoURL}" alt="Foto do perfil" class="profile-picture" id="profilePicture">
                    <div class="profile-dropdown">
                        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                        <a href="profile.html"><i class="fas fa-user"></i> Meu Perfil</a>
                        <div class="divider"></div>
                        <a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
                    </div>
                `;
                document.getElementById('logout').addEventListener('click', (e) => {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        window.location.href = 'index.html';
                    });
                });
            } else {
                window.location.href = 'login.html';
            }
        }

        function renderCampaignList(campaigns) {
            myCampaignsList.innerHTML = '';
            if (campaigns.length > 0) {
                campaigns.forEach(campaign => {
                    const campaignCard = document.createElement('div');
                    campaignCard.className = 'campaign-card';
                    campaignCard.innerHTML = `
                        <div class="campaign-info">
                            <h3 class="campaign-name">${campaign.name}</h3>
                            <p class="campaign-owner">${campaign.ownerName || 'Mestre Desconhecido'}</p>
                            <p class="campaign-code">Código: <strong>${campaign.code}</strong></p>
                        </div>
                        <div class="campaign-actions">
                            <button class="btn btn-primary">Ver Detalhes</button>
                        </div>
                    `;
                    myCampaignsList.appendChild(campaignCard);
                });
            } else {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'empty-message';
                emptyMessage.textContent = 'Nenhuma campanha criada ou participada ainda.';
                myCampaignsList.appendChild(emptyMessage);
            }
        }

        async function loadUserCampaigns(userId) {
            showLoading();
            pageState.campaigns = [];
            console.log('Carregando campanhas para o usuário:', userId);

            try {
                // Buscar todas as campanhas onde o usuário é o dono OU está na lista de membros
                const campaignsSnapshot = await db.collection('campaigns')
                    .where('ownerId', '==', userId)
                    .get();
                campaignsSnapshot.forEach(doc => {
                    console.log('Campanha (owner):', doc.id, doc.data());
                    pageState.campaigns.push({ id: doc.id, ...doc.data() });
                });

                const memberOfSnapshot = await db.collection('campaigns')
                    .where('members', 'array-contains', userId)
                    .get();
                memberOfSnapshot.forEach(doc => {
                    const campaign = { id: doc.id, ...doc.data() };
                    // Adicionar apenas se ainda não estiver na lista (evitar duplicatas)
                    if (!pageState.campaigns.some(c => c.id === campaign.id)) {
                        console.log('Campanha (member):', doc.id, doc.data());
                        pageState.campaigns.push(campaign);
                    }
                });

                renderCampaignList(pageState.campaigns);

            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
                // Exibir mensagem de erro na UI, se necessário
            } finally {
                hideLoading();
            }
        }

        joinCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const campaignCode = campaignCodeInput.value.trim();
            if (!campaignCode) {
                joinCampaignError.textContent = 'Por favor, insira o código da campanha.';
                return;
            }

            showLoading();
            joinCampaignError.textContent = '';
            joinCampaignSuccess.textContent = '';

            try {
                const campaignsSnapshot = await db.collection('campaigns')
                    .where('code', '==', campaignCode)
                    .get();

                if (campaignsSnapshot.empty) {
                    joinCampaignError.textContent = 'Código de campanha inválido.';
                } else {
                    const campaignDoc = campaignsSnapshot.docs[0];
                    const campaignId = campaignDoc.id;
                    const userId = pageState.user.uid;
                    const campaignData = campaignDoc.data();

                    if (campaignData.members && campaignData.members.includes(userId)) {
                        joinCampaignError.textContent = 'Você já participa desta campanha.';
                    } else {
                        await db.collection('campaigns').doc(campaignId).update({
                            members: firebase.firestore.FieldValue.arrayUnion(userId)
                        });
                        joinCampaignSuccess.textContent = 'Você entrou na campanha com sucesso!';
                        campaignCodeInput.value = '';
                        loadUserCampaigns(userId); // Recarregar a lista
                    }
                }
            } catch (error) {
                console.error('Erro ao entrar na campanha:', error);
                joinCampaignError.textContent = 'Ocorreu um erro ao tentar entrar na campanha.';
            } finally {
                hideLoading();
            }
        });

        auth.onAuthStateChanged(user => {
            pageState.user = user;
            updateUserProfileNav(user);
            if (user) {
                loadUserCampaigns(user.uid);
            }
        });
    </script>
</body>
</html>
